{% extends "base.html" %}

{% block title %}Reports - Time Management System{% endblock %}

{% block content %}
<!-- Reports Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-chart-bar me-2"></i>Reports & Analytics
            </h1>
            <div>
                <button class="btn btn-success me-2" onclick="exportReport()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
                <button class="btn btn-primary" onclick="scheduleReport()">
                    <i class="fas fa-calendar-plus me-1"></i>Schedule Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Report Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Report Filters</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="reportType" class="form-label">Report Type</label>
                        <select class="form-select" id="reportType" onchange="changeReportType()">
                            <option value="attendance">Attendance Report</option>
                            <option value="overtime">Overtime Report</option>
                            <option value="project">Project Time Report</option>
                            <option value="leave">Leave Report</option>
                            <option value="productivity">Productivity Report</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="dateRange" class="form-label">Date Range</label>
                        <select class="form-select" id="dateRange" onchange="changeDateRange()">
                            <option value="today">Today</option>
                            <option value="week" selected>This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="col-md-2" id="customDateRange" style="display: none;">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-2" id="customDateRange2" style="display: none;">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    {% if current_user.role in ['admin', 'manager'] %}
                    <div class="col-md-2">
                        <label for="employeeFilter" class="form-label">Employee</label>
                        <select class="form-select" id="employeeFilter">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="departmentFilter" class="form-label">Department</label>
                        <select class="form-select" id="departmentFilter">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    {% endif %}
                    <div class="col-md-1 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-4 mb-4" id="summaryCards">
    <div class="col-xl-3 col-md-6">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Hours</h6>
                        <h3 class="mb-0" id="totalHoursCard">0.0</h3>
                        <small class="opacity-75">Regular + Overtime</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Regular Hours</h6>
                        <h3 class="mb-0" id="regularHoursCard">0.0</h3>
                        <small class="opacity-75">Standard work time</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-business-time fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Overtime Hours</h6>
                        <h3 class="mb-0" id="overtimeHoursCard">0.0</h3>
                        <small class="opacity-75">Extra time worked</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-plus-circle fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Attendance Rate</h6>
                        <h3 class="mb-0" id="attendanceRateCard">0%</h3>
                        <small class="opacity-75">On-time arrivals</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-percentage fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- Main Chart -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="mainChartTitle">Attendance Overview</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" onclick="switchMainChart('hours')">Hours</button>
                    <button class="btn btn-outline-primary" onclick="switchMainChart('days')">Days</button>
                    <button class="btn btn-outline-primary" onclick="switchMainChart('projects')">Projects</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="mainChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Secondary Chart -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0" id="secondaryChartTitle">Time Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="secondaryChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Report Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="tableTitle">Detailed Report</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="prevPage()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="btn btn-outline-secondary" id="pageInfo">Page 1 of 1</span>
                    <button class="btn btn-outline-secondary" onclick="nextPage()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="reportTable">
                        <thead id="tableHead">
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Options Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exportFormat" class="form-label">Export Format</label>
                    <select class="form-select" id="exportFormat">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel (.xlsx)</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="exportEmail" class="form-label">Email to (optional)</label>
                    <input type="email" class="form-control" id="exportEmail" placeholder="Enter email address">
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeCharts">
                        <label class="form-check-label" for="includeCharts">
                            Include charts and graphs
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performExport()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let mainChart, secondaryChart;
let currentReportData = null;
let currentPage = 1;
let totalPages = 1;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadFilters();
    generateReport();
});

function initializeCharts() {
    // Main Chart
    const mainCtx = document.getElementById('mainChart').getContext('2d');
    mainChart = new Chart(mainCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Secondary Chart
    const secondaryCtx = document.getElementById('secondaryChart').getContext('2d');
    secondaryChart = new Chart(secondaryCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
}

function loadFilters() {
    {% if current_user.role in ['admin', 'manager'] %}
    // Load employees
    fetch('/api/employees')
    .then(response => response.json())
    .then(employees => {
        const select = document.getElementById('employeeFilter');
        employees.forEach(employee => {
            const option = document.createElement('option');
            option.value = employee.id;
            option.textContent = `${employee.first_name} ${employee.last_name}`;
            select.appendChild(option);
        });
    })
    .catch(error => console.error('Error loading employees:', error));

    // Load departments
    fetch('/api/departments')
    .then(response => response.json())
    .then(departments => {
        const select = document.getElementById('departmentFilter');
        departments.forEach(department => {
            const option = document.createElement('option');
            option.value = department.id;
            option.textContent = department.name;
            select.appendChild(option);
        });
    })
    .catch(error => console.error('Error loading departments:', error));
    {% endif %}
}

function changeReportType() {
    const reportType = document.getElementById('reportType').value;
    const title = {
        'attendance': 'Attendance Report',
        'overtime': 'Overtime Report',
        'project': 'Project Time Report',
        'leave': 'Leave Report',
        'productivity': 'Productivity Report'
    }[reportType];

    document.getElementById('mainChartTitle').textContent = title;
    document.getElementById('tableTitle').textContent = title;

    generateReport();
}

function changeDateRange() {
    const dateRange = document.getElementById('dateRange').value;
    const customRange1 = document.getElementById('customDateRange');
    const customRange2 = document.getElementById('customDateRange2');

    if (dateRange === 'custom') {
        customRange1.style.display = 'block';
        customRange2.style.display = 'block';
    } else {
        customRange1.style.display = 'none';
        customRange2.style.display = 'none';
    }

    if (dateRange !== 'custom') {
        generateReport();
    }
}

function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const dateRange = document.getElementById('dateRange').value;

    let startDate, endDate;

    if (dateRange === 'custom') {
        startDate = document.getElementById('startDate').value;
        endDate = document.getElementById('endDate').value;
    } else {
        const dates = getDateRange(dateRange);
        startDate = dates.start;
        endDate = dates.end;
    }

    const filters = {
        report_type: reportType,
        start_date: startDate,
        end_date: endDate,
        {% if current_user.role in ['admin', 'manager'] %}
        employee_id: document.getElementById('employeeFilter').value,
        department_id: document.getElementById('departmentFilter').value,
        {% endif %}
        page: currentPage
    };

    fetch('/api/reports?' + new URLSearchParams(filters))
    .then(response => response.json())
    .then(data => {
        currentReportData = data;
        updateSummaryCards(data.summary);
        updateMainChart(data.chart_data);
        updateSecondaryChart(data.secondary_chart);
        updateReportTable(data.table_data);
        updatePagination(data.pagination);
    })
    .catch(error => {
        console.error('Error generating report:', error);
        showAlert('Failed to generate report', 'danger');
    });
}

function getDateRange(range) {
    const today = new Date();
    let start, end;

    switch (range) {
        case 'today':
            start = end = today.toISOString().split('T')[0];
            break;
        case 'week':
            const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
            const endOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 6));
            start = startOfWeek.toISOString().split('T')[0];
            end = endOfWeek.toISOString().split('T')[0];
            break;
        case 'month':
            start = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            end = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
            break;
        case 'quarter':
            const quarter = Math.floor((today.getMonth() + 3) / 3);
            start = new Date(today.getFullYear(), (quarter - 1) * 3, 1).toISOString().split('T')[0];
            end = new Date(today.getFullYear(), quarter * 3, 0).toISOString().split('T')[0];
            break;
        case 'year':
            start = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
            end = new Date(today.getFullYear(), 11, 31).toISOString().split('T')[0];
            break;
    }

    return { start, end };
}

function updateSummaryCards(summary) {
    document.getElementById('totalHoursCard').textContent = (summary.total_hours || 0).toFixed(1);
    document.getElementById('regularHoursCard').textContent = (summary.regular_hours || 0).toFixed(1);
    document.getElementById('overtimeHoursCard').textContent = (summary.overtime_hours || 0).toFixed(1);
    document.getElementById('attendanceRateCard').textContent = (summary.attendance_rate || 0).toFixed(1) + '%';
}

function updateMainChart(chartData) {
    if (!chartData) return;

    mainChart.data.labels = chartData.labels || [];
    mainChart.data.datasets = chartData.datasets || [];
    mainChart.update();
}

function updateSecondaryChart(chartData) {
    if (!chartData) return;

    secondaryChart.data.labels = chartData.labels || [];
    secondaryChart.data.datasets = chartData.datasets || [];
    secondaryChart.update();
}

function updateReportTable(tableData) {
    if (!tableData) return;

    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');

    // Update table headers
    thead.innerHTML = '';
    if (tableData.headers) {
        const headerRow = document.createElement('tr');
        tableData.headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
    }

    // Update table body
    tbody.innerHTML = '';
    if (tableData.rows) {
        tableData.rows.forEach(row => {
            const tr = document.createElement('tr');
            row.forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }
}

function updatePagination(pagination) {
    if (!pagination) return;

    currentPage = pagination.current_page || 1;
    totalPages = pagination.total_pages || 1;

    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
}

function switchMainChart(type) {
    // Update active button
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // Generate new chart data based on type
    const reportType = document.getElementById('reportType').value + '_' + type;
    // This would trigger a new API call with the specific chart type
    generateReport();
}

function exportReport() {
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

function performExport() {
    const format = document.getElementById('exportFormat').value;
    const email = document.getElementById('exportEmail').value;
    const includeCharts = document.getElementById('includeCharts').checked;

    const exportData = {
        format: format,
        email: email,
        include_charts: includeCharts,
        report_filters: {
            report_type: document.getElementById('reportType').value,
            date_range: document.getElementById('dateRange').value,
            {% if current_user.role in ['admin', 'manager'] %}
            employee_id: document.getElementById('employeeFilter').value,
            department_id: document.getElementById('departmentFilter').value,
            {% endif %}
        }
    };

    fetch('/api/export-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(exportData)
    })
    .then(response => {
        if (response.ok) {
            if (format === 'pdf' || format === 'excel' || format === 'csv') {
                return response.blob();
            }
            return response.json();
        }
        throw new Error('Export failed');
    })
    .then(data => {
        if (data instanceof Blob) {
            // Download file
            const url = window.URL.createObjectURL(data);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `report.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        showAlert('Report exported successfully!', 'success');

        const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
        modal.hide();
    })
    .catch(error => {
        console.error('Export error:', error);
        showAlert('Failed to export report', 'danger');
    });
}

function scheduleReport() {
    // Placeholder for scheduling recurring reports
    showAlert('Scheduled reports feature coming soon!', 'info');
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        generateReport();
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        generateReport();
    }
}
</script>
{% endblock %}
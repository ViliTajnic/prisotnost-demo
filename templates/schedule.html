{% extends "base.html" %}

{% block title %}Schedule - Time Management System{% endblock %}

{% block content %}
<!-- Schedule Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-calendar-alt me-2"></i>Schedule
            </h1>
            <div>
                {% if current_user.role in ['admin', 'manager'] %}
                <button class="btn btn-success me-2" onclick="createSchedule()">
                    <i class="fas fa-plus me-1"></i>Create Schedule
                </button>
                <button class="btn btn-info me-2" onclick="manageTemplates()">
                    <i class="fas fa-layer-group me-1"></i>Templates
                </button>
                {% endif %}
                <div class="btn-group">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-filter me-1"></i>View
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="changeView('month')">Month View</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeView('week')">Week View</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeView('day')">Day View</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="changeView('list')">List View</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 class="mb-0" id="todayShifts">0</h4>
                <small>Today's Shifts</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 class="mb-0" id="weekShifts">0</h4>
                <small>This Week</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4 class="mb-0" id="conflictCount">0</h4>
                <small>Conflicts</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4 class="mb-0" id="totalHours">0</h4>
                <small>Scheduled Hours</small>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Container -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar me-2"></i>Schedule Calendar
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="calendar.prev()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="calendar.today()">
                        Today
                    </button>
                    <button class="btn btn-outline-secondary" onclick="calendar.next()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Upcoming Shifts (List View) -->
<div class="row mt-4" id="listView" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Upcoming Shifts</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Employee</th>
                                <th>Shift Type</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shiftsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleModalTitle">Create Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="employeeSelect" class="form-label">Employee</label>
                                <select class="form-select" id="employeeSelect" required>
                                    <option value="">Select Employee</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="shiftType" class="form-label">Shift Type</label>
                                <select class="form-select" id="shiftType" required>
                                    <option value="">Select Shift Type</option>
                                    <option value="morning">Morning Shift</option>
                                    <option value="afternoon">Afternoon Shift</option>
                                    <option value="evening">Evening Shift</option>
                                    <option value="night">Night Shift</option>
                                    <option value="full-day">Full Day</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endDate" class="form-label">End Date (for recurring)</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startTime" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="startTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endTime" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="endTime" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isRecurring">
                            <label class="form-check-label" for="isRecurring">
                                Recurring Schedule
                            </label>
                        </div>
                    </div>

                    <div id="recurringOptions" style="display: none;">
                        <div class="mb-3">
                            <label for="recurrencePattern" class="form-label">Recurrence Pattern</label>
                            <select class="form-select" id="recurrencePattern">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Repeat On (for weekly)</label>
                            <div class="btn-group d-flex" role="group" id="weekDays">
                                <input type="checkbox" class="btn-check" id="mon" value="1">
                                <label class="btn btn-outline-primary" for="mon">Mon</label>
                                <input type="checkbox" class="btn-check" id="tue" value="2">
                                <label class="btn btn-outline-primary" for="tue">Tue</label>
                                <input type="checkbox" class="btn-check" id="wed" value="3">
                                <label class="btn btn-outline-primary" for="wed">Wed</label>
                                <input type="checkbox" class="btn-check" id="thu" value="4">
                                <label class="btn btn-outline-primary" for="thu">Thu</label>
                                <input type="checkbox" class="btn-check" id="fri" value="5">
                                <label class="btn btn-outline-primary" for="fri">Fri</label>
                                <input type="checkbox" class="btn-check" id="sat" value="6">
                                <label class="btn btn-outline-primary" for="sat">Sat</label>
                                <input type="checkbox" class="btn-check" id="sun" value="0">
                                <label class="btn btn-outline-primary" for="sun">Sun</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="scheduleNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="scheduleNotes" rows="3" placeholder="Additional notes or instructions"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                    <i class="fas fa-save me-1"></i>Save Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Shift Templates Modal -->
<div class="modal fade" id="templatesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Shift Templates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button class="btn btn-primary btn-sm" onclick="createTemplate()">
                        <i class="fas fa-plus me-1"></i>New Template
                    </button>
                </div>
                <div id="templatesList">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let calendar;
let currentView = 'month';
let schedules = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    loadSchedules();
    loadEmployees();
    setupEventListeners();
});

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');

    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        height: 'auto',
        events: [],
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        weekends: true,
        editable: {% if current_user.role in ['admin', 'manager'] %}true{% else %}false{% endif %},

        select: function(info) {
            {% if current_user.role in ['admin', 'manager'] %}
            createScheduleForDate(info.start, info.end);
            {% endif %}
        },

        eventClick: function(info) {
            showScheduleDetails(info.event);
        },

        eventDrop: function(info) {
            {% if current_user.role in ['admin', 'manager'] %}
            updateScheduleTime(info.event, info.delta);
            {% endif %}
        },

        eventResize: function(info) {
            {% if current_user.role in ['admin', 'manager'] %}
            updateScheduleDuration(info.event, info.endDelta);
            {% endif %}
        }
    });

    calendar.render();
}

function loadSchedules() {
    const token = localStorage.getItem('access_token');

    fetch('/api/schedules', {
        headers: {
            'Authorization': 'Bearer ' + token
        }
    })
    .then(response => response.json())
    .then(data => {
        schedules = data.schedules || [];
        updateCalendarEvents();
        updateScheduleStats();
    })
    .catch(error => {
        console.error('Error loading schedules:', error);
        showAlert('Failed to load schedules', 'danger');
    });
}

function updateCalendarEvents() {
    const events = schedules.map(schedule => ({
        id: schedule.id,
        title: `${schedule.user_name} - ${schedule.shift_type}`,
        start: schedule.start_time,
        end: schedule.end_time,
        backgroundColor: getShiftColor(schedule.shift_type),
        borderColor: getShiftColor(schedule.shift_type),
        extendedProps: {
            schedule: schedule
        }
    }));

    calendar.removeAllEvents();
    calendar.addEventSource(events);
}

function getShiftColor(shiftType) {
    const colors = {
        'morning': '#28a745',
        'afternoon': '#ffc107',
        'evening': '#fd7e14',
        'night': '#6f42c1',
        'full-day': '#007bff',
        'custom': '#6c757d'
    };
    return colors[shiftType] || '#6c757d';
}

function updateScheduleStats() {
    const today = new Date();
    const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
    const endOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 6));

    const todayShifts = schedules.filter(s =>
        new Date(s.start_time).toDateString() === new Date().toDateString()
    ).length;

    const weekShifts = schedules.filter(s => {
        const shiftDate = new Date(s.start_time);
        return shiftDate >= startOfWeek && shiftDate <= endOfWeek;
    }).length;

    const conflicts = detectConflicts();
    const totalHours = calculateTotalHours();

    document.getElementById('todayShifts').textContent = todayShifts;
    document.getElementById('weekShifts').textContent = weekShifts;
    document.getElementById('conflictCount').textContent = conflicts.length;
    document.getElementById('totalHours').textContent = totalHours.toFixed(1);
}

function detectConflicts() {
    const conflicts = [];
    // Simple conflict detection - check for overlapping schedules
    for (let i = 0; i < schedules.length; i++) {
        for (let j = i + 1; j < schedules.length; j++) {
            const schedule1 = schedules[i];
            const schedule2 = schedules[j];

            if (schedule1.user_id === schedule2.user_id) {
                const start1 = new Date(schedule1.start_time);
                const end1 = new Date(schedule1.end_time);
                const start2 = new Date(schedule2.start_time);
                const end2 = new Date(schedule2.end_time);

                if ((start1 < end2) && (start2 < end1)) {
                    conflicts.push({schedule1, schedule2});
                }
            }
        }
    }
    return conflicts;
}

function calculateTotalHours() {
    const thisWeek = schedules.filter(s => {
        const shiftDate = new Date(s.start_time);
        const today = new Date();
        const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
        const endOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 6));
        return shiftDate >= startOfWeek && shiftDate <= endOfWeek;
    });

    return thisWeek.reduce((total, schedule) => {
        const start = new Date(schedule.start_time);
        const end = new Date(schedule.end_time);
        const hours = (end - start) / (1000 * 60 * 60);
        return total + hours;
    }, 0);
}

function loadEmployees() {
    {% if current_user.role in ['admin', 'manager'] %}
    const token = localStorage.getItem('access_token');

    fetch('/api/employees', {
        headers: {
            'Authorization': 'Bearer ' + token
        }
    })
    .then(response => response.json())
    .then(employees => {
        const select = document.getElementById('employeeSelect');
        select.innerHTML = '<option value="">Select Employee</option>';

        employees.forEach(employee => {
            const option = document.createElement('option');
            option.value = employee.id;
            option.textContent = `${employee.first_name} ${employee.last_name}`;
            select.appendChild(option);
        });
    })
    .catch(error => {
        console.error('Error loading employees:', error);
    });
    {% endif %}
}

function setupEventListeners() {
    // Recurring schedule checkbox
    document.getElementById('isRecurring').addEventListener('change', function() {
        const recurringOptions = document.getElementById('recurringOptions');
        recurringOptions.style.display = this.checked ? 'block' : 'none';
    });

    // Shift type change
    document.getElementById('shiftType').addEventListener('change', function() {
        const shiftType = this.value;
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');

        // Set default times based on shift type
        const defaults = {
            'morning': {start: '06:00', end: '14:00'},
            'afternoon': {start: '14:00', end: '22:00'},
            'evening': {start: '16:00', end: '00:00'},
            'night': {start: '22:00', end: '06:00'},
            'full-day': {start: '08:00', end: '17:00'}
        };

        if (defaults[shiftType]) {
            startTime.value = defaults[shiftType].start;
            endTime.value = defaults[shiftType].end;
        }
    });
}

function createSchedule() {
    const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    document.getElementById('scheduleModalTitle').textContent = 'Create Schedule';
    document.getElementById('scheduleForm').reset();
    modal.show();
}

function createScheduleForDate(start, end) {
    const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    document.getElementById('scheduleModalTitle').textContent = 'Create Schedule';
    document.getElementById('scheduleForm').reset();

    // Set the selected date
    document.getElementById('startDate').value = start.toISOString().split('T')[0];

    modal.show();
}

function saveSchedule() {
    const form = document.getElementById('scheduleForm');
    const formData = new FormData(form);

    const scheduleData = {
        user_id: document.getElementById('employeeSelect').value,
        shift_type: document.getElementById('shiftType').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        start_time: document.getElementById('startTime').value,
        end_time: document.getElementById('endTime').value,
        is_recurring: document.getElementById('isRecurring').checked,
        recurrence_pattern: document.getElementById('recurrencePattern').value,
        notes: document.getElementById('scheduleNotes').value
    };

    if (scheduleData.is_recurring) {
        const selectedDays = [];
        document.querySelectorAll('#weekDays input:checked').forEach(input => {
            selectedDays.push(input.value);
        });
        scheduleData.week_days = selectedDays;
    }

    const token = localStorage.getItem('access_token');

    fetch('/api/schedules', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(scheduleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert(data.error, 'danger');
        } else {
            showAlert('Schedule created successfully!', 'success');
            loadSchedules();

            const modal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
            modal.hide();
        }
    })
    .catch(error => {
        console.error('Error saving schedule:', error);
        showAlert('Failed to save schedule', 'danger');
    });
}

function changeView(view) {
    currentView = view;

    if (view === 'list') {
        document.getElementById('calendar').style.display = 'none';
        document.getElementById('listView').style.display = 'block';
        loadListView();
    } else {
        document.getElementById('calendar').style.display = 'block';
        document.getElementById('listView').style.display = 'none';

        const viewMap = {
            'month': 'dayGridMonth',
            'week': 'timeGridWeek',
            'day': 'timeGridDay'
        };

        calendar.changeView(viewMap[view]);
    }
}

function loadListView() {
    const tbody = document.getElementById('shiftsTableBody');
    tbody.innerHTML = '';

    const sortedSchedules = [...schedules].sort((a, b) =>
        new Date(a.start_time) - new Date(b.start_time)
    );

    sortedSchedules.forEach(schedule => {
        const row = document.createElement('tr');
        const startDate = new Date(schedule.start_time);
        const endTime = new Date(schedule.end_time);
        const duration = (endTime - startDate) / (1000 * 60 * 60);

        row.innerHTML = `
            <td>${startDate.toLocaleDateString()}</td>
            <td>${schedule.user_name}</td>
            <td><span class="badge" style="background-color: ${getShiftColor(schedule.shift_type)}">${schedule.shift_type}</span></td>
            <td>${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
            <td>${endTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
            <td>${duration.toFixed(1)}h</td>
            <td><span class="badge bg-${schedule.status === 'scheduled' ? 'primary' : 'success'}">${schedule.status}</span></td>
            <td>
                {% if current_user.role in ['admin', 'manager'] %}
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editSchedule(${schedule.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSchedule(${schedule.id})">
                    <i class="fas fa-trash"></i>
                </button>
                {% endif %}
            </td>
        `;
        tbody.appendChild(row);
    });
}

function showScheduleDetails(event) {
    const schedule = event.extendedProps.schedule;
    const start = new Date(schedule.start_time);
    const end = new Date(schedule.end_time);

    const details = `
        <strong>Employee:</strong> ${schedule.user_name}<br>
        <strong>Shift:</strong> ${schedule.shift_type}<br>
        <strong>Date:</strong> ${start.toLocaleDateString()}<br>
        <strong>Time:</strong> ${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}<br>
        <strong>Duration:</strong> ${((end - start) / (1000 * 60 * 60)).toFixed(1)} hours<br>
        ${schedule.notes ? `<strong>Notes:</strong> ${schedule.notes}` : ''}
    `;

    showAlert(details, 'info', 0);
}

function manageTemplates() {
    const modal = new bootstrap.Modal(document.getElementById('templatesModal'));
    loadTemplates();
    modal.show();
}

function loadTemplates() {
    // Placeholder for template loading
    document.getElementById('templatesList').innerHTML = `
        <div class="list-group">
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">Standard Morning Shift</h6>
                    <small class="text-muted">6:00 AM - 2:00 PM</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">Evening Shift</h6>
                    <small class="text-muted">4:00 PM - 12:00 AM</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>
    `;
}
</script>
{% endblock %}